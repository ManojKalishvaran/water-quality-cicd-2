name: water-quality-cicd-$(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - Training/**
      - inference/**
      - README.md

pool:
  vmImage: 'ubuntu-latest'

variables:
  trainingImageName: 'water-quality-training'
  inferenceImageName: 'water-quality-inference'
  tag: 'latest'

stages:
# ==================================================================================
# BUILD STAGE
# ==================================================================================
- stage: Build
  displayName: 'Build & Push Docker Images'
  jobs:

  # ------------------------------------------------------------------------------
  # Job 1: Build and push training image, then run the container
  # ------------------------------------------------------------------------------
  - job: LoginAndBuild
    displayName: 'Key Vault Login + Build Images'
    steps:

    # Step 1: Get secrets from Key Vault
    - task: AzureKeyVault@2
      name: FetchSecrets
      inputs:
        azureSubscription: 'az-sub'
        keyVaultName: 'manoj-key-water'
        SecretsFilter: '*'
        RunAsPreJob: true

    # Step 2: Checkout
    - checkout: self

    # Step 3: Build and push training image
    - task: Docker@2
      displayName: 'Build & Push Training Image to ACR'
      inputs:
        containerRegistry: 'acr-connection'
        repository: '$(trainingImageName)'
        command: 'buildAndPush'
        Dockerfile: '**/Training/Dockerfile'
        tags: |
          $(tag)

    # Step 4: Pull training image from ACR
    - task: Docker@2
      displayName: 'Pull Training Image from ACR'
      inputs:
        containerRegistry: 'acr-connection'
        repository: '$(trainingImageName)'
        command: 'pull'
        tags: |
          $(tag)

    # Step 5: Run the training container
    - script: |
        echo "Running training container..."
        docker run manojacrregistry.azurecr.io/$(trainingImageName):$(tag)
      displayName: 'Run Training Container'

  # ------------------------------------------------------------------------------
  # Job 2: Build and push inference image
  # ------------------------------------------------------------------------------
  - job: BuildInferenceImage
    displayName: 'Build Inference Docker Image'
    dependsOn: LoginAndBuild
    steps:
    - checkout: self

    - task: Docker@2
      displayName: 'Build & Push Inference Image to ACR'
      inputs:
        containerRegistry: 'acr-connection'
        repository: '$(inferenceImageName)'
        command: 'buildAndPush'
        Dockerfile: '**/inference/Dockerfile'
        tags: |
          $(tag)

# ==================================================================================
# DEPLOY STAGE
# ==================================================================================
- stage: Deploy
  displayName: 'Deploy Inference Container to Azure App Service'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: DeployInference
    displayName: 'Deploy Inference Container'
    steps:
    - task: AzureWebAppContainer@1
      displayName: 'Deploy Inference Container to App Service'
      inputs:
        azureSubscription: 'az-sub'
        appName: 'water-quality-api'
        containers: 'manojacrregistry.azurecr.io/$(inferenceImageName):$(tag)'
